<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Map Sheets Creator</title>

        <link type="text/css" href="thirdparty/css/no-theme/jquery-ui-1.8.5.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.4.2.min.js"          ></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.5.custom.min.js"></script>
        <script type="text/javascript" src="thirdparty/js/OpenLayers.js"     ></script>
		<script type="text/javascript" src="js/LayerSwitcherWithOrder.js "   ></script>
        
        <link type="text/css" href="css/sheetcomposer.css"                   rel="stylesheet" />
        <script type="text/javascript" src="js/main.js" ></script>
        
        <script type="text/javascript">
            $(function() {
                $( "#renderWidget" ).draggable({containment: '#map_canvas', zIndex: 2700});
            });
        </script>

        <script type="text/javascript">
            var map = {};
            var gTestPolyline = {};
            var gSheetController = {};
            var gMapLayoutWidget = {};
            var gLogger = {};
            
            var MAP_HOST_NAME = 'http://188.127.225.240';
            
            function showAboutPage(event)
            {
                $('#aboutWindow').dialog({width:700, 
                                    modal: true, 
                                    title: 'About',
                                    zindex: 30000});
            }
                        
            
            function get_my_url (bounds) {
                var res = this.map.getResolution();
                var x = Math.round ((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
                var y = Math.round ((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
                
                var z = this.map.getZoom();

                var path = "Z" + z + "/" + y + "_" + x + ".png";
                var url = this.url;
                if (url instanceof Array) {
                    url = this.selectUrl(path, url);
                }
                
                return url + path;
            }
            
            function initialize()
            {                
                var slazavLayer = new OpenLayers.Layer.TMS("Slazav",
                           MAP_HOST_NAME + "/maps/slazav/",
                           { 'type':'png', 'getURL':get_my_url, transparent: 'true' });
                           
                var arbaletLayer = new OpenLayers.Layer.TMS("Arbalet",
                           MAP_HOST_NAME + "/maps/arbalet/",
                           { 'type':'png', 'getURL':get_my_url, transparent: 'true' });
                
                var osmLayer = new OpenLayers.Layer.OSM();
                
                var serverNamesMap = {};
                serverNamesMap[slazavLayer.name] = 'slazav',
                serverNamesMap[arbaletLayer.name] = 'arbalet';
                
                map = new OpenLayers.Map("map_canvas", {
                    maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                    numZoomLevels:18,
                    maxResolution:156543.0339,
                    units:'m',
                    projection: "EPSG:900913",
                    displayProjection: new OpenLayers.Projection("EPSG:4326"),
                    allOverlays: true
                });
                
                map.addLayers([osmLayer, arbaletLayer, slazavLayer]);
            
                map.addControl( new OpenLayers.Control.LayerSwitcherWithOrder() );
                
                var mapCenterLonLat = new OpenLayers.LonLat(37.98, 55.78)
                map.setCenter(mapCenterLonLat.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()), 8);
                                
                //var curLogger = new DivLogger();
                var curLogger = new NullLogger();
                
                gLogger = curLogger;
                    
                gMapLayoutWidget = new MapLayoutWidget(map, serverNamesMap);
                gSheetController = new SheetController( map, curLogger );
                
                //layout
                $("#renderWidget").outerWidth( $("#sheetOptionsWidgetContainer").outerWidth() );
                $("#renderWidget").css( { bottom: $("#sheetOptionsWidgetContainer").outerHeight()} );
            }
            
            function renderSheet()
            {
                if ( !gSheetController.isDataValid() )
                {
                    alert("Enter correct sheet options!");
                    return;
                }
                
                var renderData = gSheetController.getSheetData();
                
                //TODO: move check to Sheet class
                var sizeX = renderData.maxx - renderData.minx + 1;
                var sizeY = renderData.maxy - renderData.miny + 1;
                if (sizeX*sizeY > MAX_PIXELS)
                {
                    alert('Too big sheet! Limit is ' + MAX_PIXELS + ' pixels');
                    return;
                }
                
                var mapLayoutData = gMapLayoutWidget.getMapLayout();
                renderData['map_layout'] = mapLayoutData;
                
                $('#download_link').text('Rendering in process...');
                
                $.ajax({type:"get", url: "cgi-bin/render.cgi", data: renderData, dataType: "json", success: function(data)
                {
                    if (data.error)
                    {
                        alert("Error during rendering: " + data.error);
                        $('#download_link').empty();
                        return;
                    }
                    
                    $('#download_link').html($('<a></a>').attr({href: 'sheets/'+data.pic_filename}).text('Rendered picture file'))
                                       .append($('<br/>'))
                                       .append($('<a></a>').attr({href: 'sheets/'+data.map_filename}).text('Rendered map file'));
                    
                    if (data.debug) gLogger.message("Debug from server: <br/><i>" + data.debug.join('<br/>') + '</i>');
                }, error: function(request, textStatus, error){
                    alert("Error at server!\nStatus: " + textStatus + "\nError: " + error);
                    $('#download_link').empty();
                }});
            }
        </script>
    </head>

    <body onload="initialize()" onunload="GUnload()" style="margin:0; padding:0; overflow:hidden;">
        <div id="map_canvas" style="width: 100%; height: 100%; margin:0; padding:0; overflow:hidden;"></div>
        <div id="renderWidget" class="ui-widget-content">
                <form><input type="button" value="Render Sheet" onclick="renderSheet();" style="width:100%" ></form>
                <p id="download_link"></p>
        </div>
        
        <!--#include virtual="sheet_options_widget.html" -->
        
        <div id="aboutButton" onclick="showAboutPage();">About</div>
        <div id="aboutWindow">
            <H3>Map Sheet Creator</H3>
            <p>Compose printable map sheets from map tiles.</p>
            <H3>Contacts</H3>
            <p>
                I will be glad to any bug reports, suggestions or notes about this project. You can
                <ul>
                    <li>Write me e-mail to <a href="mailto:parshin.alexander@gmail.com">parshin.alexander@gmail.com</a></li>
                    <li>Post new ticket in <a href="/trac">project trac</a></li>
                </ul>
            </p>
            <H3>Thanks</H3>
            <ul>
                <li>To Alexander Zibrov for suggestions, great ideas and interest</li>
                <li>To Vladislav Zavjalov for <a href="http://slazav.mccme.ru/maps/">great Moscow Region maps</a></li>
                <li>To Dmitrij Zhurakovskij for scanned sheets of Arbalet maps</li>
            </ul>
            
            <H3>Change Log</H3>
            <ul>
                <li>v1.0 beta (15.12.2010) Initial version
            </ul>
        </div>
       
    </body>
</html>